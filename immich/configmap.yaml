apiVersion: v1
kind: ConfigMap
metadata:
  name: immich-config
  namespace: immich
data:
  # Database Connection
  DB_HOSTNAME: "immich-db"
  DB_USERNAME: "immich"
  DB_DATABASE_NAME: "immich"
  DB_PORT: "5432"

  # Redis Connection
  REDIS_HOSTNAME: "immich-redis"
  REDIS_PORT: "6379"
  
  # Application Settings
  NODE_ENV: "production"
  IMMICH_ENV: "production"
  
  # Folder paths (internal container paths)
  UPLOAD_LOCATION: "/usr/src/app/upload"
  IMMICH_MACHINE_LEARNING_URL: "http://immich-machine-learning:3003"
  
  TZ: "Europe/Dublin"

  # Sidecar Script for Job Scheduling
  job-scheduler.sh: |
    #!/bin/sh
    set -e
    
    # Configuration
    # We use localhost because containers in the same POD share the network namespace.
    # Accessing via Ingress (immich.home) would require hair-pinning out and back in, 
    # which relies on DNS and Ingress Controller availability. Localhost is safer/faster.
    API_URL="http://localhost:2283/api"
    
    # WAITING FOR SERVER START
    echo "Waiting for Immich Server..."
    # Loop until localhost port 2283 is open
    while ! nc -z localhost 2283; do   
      sleep 5
    done
    echo "Immich Server is up."

    # CRON LOOP
    # Run storage-template-migration every night at 2am
    echo "Starting Job Scheduler..."
    
    while true; do
        current_hour=$(date +%H)
        
        # Trigger at 02:00 AM
        if [ "$current_hour" -eq "02" ]; then
             echo "[$(date)] Triggering Storage Template Migration Job..."
             
             if [ -n "$IMMICH_API_KEY" ]; then
                 # -f fails silently on server errors, -S shows error if fails
                 if curl -f -X POST "$API_URL/jobs/storage-template-migration" \
                      -H "x-api-key: $IMMICH_API_KEY" \
                      -H "Content-Type: application/json" \
                      -d '{"command":"start"}'; then
                      echo "Job started successfully."
                 else
                      echo "Failed to start job. Server returned error."
                 fi
             else
                 echo "No API Key found. Skipping automatic trigger."
             fi
             
             # Sleep for an hour to avoid repeated triggers
             sleep 3600
        fi
        
        # Check every 30 minutes
        sleep 1800
    done
