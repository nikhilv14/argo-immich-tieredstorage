apiVersion: v1
kind: ConfigMap
metadata:
  name: immich-config
  namespace: immich
data:
  # Database Connection
  DB_HOSTNAME: "immich-db"
  DB_USERNAME: "immich"
  DB_DATABASE_NAME: "immich"
  DB_PORT: "5432"

  # Redis Connection
  REDIS_HOSTNAME: "immich-redis"
  REDIS_PORT: "6379"
  
  # Application Settings
  NODE_ENV: "production"
  IMMICH_ENV: "production"
  
  # Folder paths (internal container paths)
  UPLOAD_LOCATION: "/usr/src/app/upload"
  IMMICH_MACHINE_LEARNING_URL: "http://immich-machine-learning:3003"
  
  TZ: "Europe/Dublin"

  # Sidecar Scripts
  sync-daemon.sh: |
    #!/bin/sh
    set -e
    
    # Dependencies: rsync, inotify-tools, findutils
    
    UPLOAD_DIR="/usr/src/app/upload/upload"
    NAS_DIR="/usr/src/app/upload/library/new-uploads"
    QUEUE_LOG="/usr/src/app/upload/sync-queue/sync.log"
    LOCK_FILE="/tmp/sync.lock"
    
    # CONFIGURATION
    # Cache Duration: How long files stay on SSD for fast access/thumbnails
    # Set to 0 for immediate removal (not recommended for cache goal)
    CACHE_MINUTES=1440  # 24 hours
    
    echo "Starting Sync Daemon..."
    echo "Watching $UPLOAD_DIR"
    echo "Syncing to $NAS_DIR"
    echo "Cache retention: $CACHE_MINUTES minutes"
    
    mkdir -p "$(dirname "$QUEUE_LOG")"
    
    perform_sync_and_cleanup() {
        if [ -f "$LOCK_FILE" ]; then
            echo "Sync in progress, skipping."
            return
        fi
        
        touch "$LOCK_FILE"
        
        # 1. CHECK NAS AVAILABILITY
        if timeout 5 ls -d "$(dirname "$NAS_DIR")" >/dev/null 2>&1; then
            mkdir -p "$NAS_DIR" 2>/dev/null || true
            
            # 2. SYNC (COPY)
            # We use copy (not move) first to ensure data safety on NAS
            # We do NOT use --remove-source-files here because we want to respect the Cache Duration
            echo "[$(date)] Starting Sync..." >> "$QUEUE_LOG"
            if rsync -av --ignore-existing "$UPLOAD_DIR/" "$NAS_DIR/"; then
                echo "[$(date)] Sync successful." >> "$QUEUE_LOG"
                
                # 3. CLEANUP (EVICTION)
                # Remove files from SSD that are:
                # a) Older than CACHE_MINUTES
                # b) Safely exist on NAS (Verified by rsync success roughly, but strictly we assume success)
                # WARNING: Immich Database must expect files to move to Library via Storage Templates
                # for this to not break image viewing. 
                
                echo "[$(date)] Running Cache Eviction (Files > $CACHE_MINUTES mins)..." >> "$QUEUE_LOG"
                # Find files in UPLOAD_DIR older than X minutes and delete them
                # Mindepth 1 to avoid deleting the root folder itself
                find "$UPLOAD_DIR" -mindepth 1 -type f -mmin +"$CACHE_MINUTES" -delete
                
                # Remove empty directories left behind
                find "$UPLOAD_DIR" -mindepth 1 -type d -empty -delete
                
            else
                echo "[$(date)] Sync failed." >> "$QUEUE_LOG"
            fi
        else
            echo "[$(date)] NAS unavailable. Skipping sync/cleanup." >> "$QUEUE_LOG"
        fi
        
        rm -f "$LOCK_FILE"
    }
    
    # Initial run
    perform_sync_and_cleanup
    
    # Watch Loop
    inotifywait -m -r -e close_write,moved_to --format '%w%f' "$UPLOAD_DIR" | while read FILE
    do
        # Debounce/Throttle slightly
        sleep 5
        perform_sync_and_cleanup
    done

  resilience-monitor.sh: |
    #!/bin/sh
    
    NAS_MOUNT="/usr/src/app/upload/library"
    LOG_FILE="/usr/src/app/upload/sync-queue/resilience.log"
    STATUS_FILE="/usr/src/app/upload/sync-queue/nas-status"
    
    echo "Starting Resilience Monitor..."
    echo "Monitoring $NAS_MOUNT"
    
    mkdir -p "$(dirname "$LOG_FILE")"
    
    while true; do
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
        
        if timeout 10 ls -d "$NAS_MOUNT" >/dev/null 2>&1; then
            if [ -f "$STATUS_FILE" ] && grep -q "UNAVAILABLE" "$STATUS_FILE"; then
                echo "[$TIMESTAMP] NAS Recovery Detected. Status: AVAILABLE" >> "$LOG_FILE"
            fi
            echo "AVAILABLE" > "$STATUS_FILE"
        else
            echo "[$TIMESTAMP] NAS Unavailable. Status: UNAVAILABLE" >> "$LOG_FILE"
            echo "UNAVAILABLE" > "$STATUS_FILE"
        fi
        
        sleep 30
    done
