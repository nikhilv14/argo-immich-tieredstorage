apiVersion: apps/v1
kind: Deployment
metadata:
  name: immich-server
  namespace: immich
  labels:
    app.kubernetes.io/name: immich-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: immich-server
  template:
    metadata:
      labels:
        app.kubernetes.io/name: immich-server
    spec:
      nodeSelector:
        kubernetes.io/hostname: k3s-node1
      # 2. GRANT GPU PERMISSIONS
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        supplementalGroups: [109, 44] # 109 is 'render' and group ID (44 is usually 'video')


      initContainers:
        - name: migrate-to-tiered-storage
          image: alpine:3.19
          command:
            - sh
            - -c
            - |
              set -e
              
              # Check if migration already completed (marker at upload root)
              MIGRATION_MARKER="/upload-pvc-root/.migration-completed"
              if [ -f "$MIGRATION_MARKER" ]; then
                echo "✓ Migration already completed. Skipping data copy."
                exit 0
              fi
              
              echo "========== Starting tiered storage migration =========="
              echo "Using subPath approach for upload PVC tier"
              echo ""
              
              # Verify source volume exists
              if [ ! -d "/source-upload" ]; then
                echo "ERROR: Source upload directory not found at /source-upload"
                exit 1
              fi
              echo "✓ Source volume available"
              
              # Step 1: Copy to upload subPath
              echo ""
              echo "Step 1: Copying to upload subPath..."
              mkdir -p /upload-pvc-root/upload
              if [ -d "/source-upload/upload" ] && [ "$(ls -A /source-upload/upload 2>/dev/null)" ]; then
                cp -av /source-upload/upload/* /upload-pvc-root/upload/ 2>/dev/null || true
                echo "✓ Upload copied ($(du -sh /upload-pvc-root/upload | cut -f1))"
              fi
              
              # Step 2: Copy to backups subPath
              echo ""
              echo "Step 2: Copying to backups subPath..."
              mkdir -p /upload-pvc-root/backups
              if [ -d "/source-upload/backups" ] && [ "$(ls -A /source-upload/backups 2>/dev/null)" ]; then
                cp -av /source-upload/backups/* /upload-pvc-root/backups/ 2>/dev/null || true
                echo "✓ Backups copied"
              fi
              
              # Step 3: Copy to encoded-video subPath
              echo ""
              echo "Step 3: Copying to encoded-video subPath..."
              mkdir -p /upload-pvc-root/encoded-video
              if [ -d "/source-upload/encoded-video" ] && [ "$(ls -A /source-upload/encoded-video 2>/dev/null)" ]; then
                cp -av /source-upload/encoded-video/* /upload-pvc-root/encoded-video/ 2>/dev/null || true
                echo "✓ Encoded-video copied"
              fi
              
              # Step 4: Copy to library tier
              echo ""
              echo "Step 4: Copying to library tier..."
              mkdir -p /library-pvc-root
              if [ -d "/source-upload/library" ] && [ "$(ls -A /source-upload/library 2>/dev/null)" ]; then
                cp -av /source-upload/library/* /library-pvc-root/ 2>/dev/null || true
                echo "✓ Library copied ($(du -sh /library-pvc-root | cut -f1))"
              fi
              
              # Step 5: Copy to profile tier
              echo ""
              echo "Step 5: Copying to profile tier..."
              mkdir -p /profile-pvc-root
              if [ -d "/source-upload/profile" ] && [ "$(ls -A /source-upload/profile 2>/dev/null)" ]; then
                cp -av /source-upload/profile/* /profile-pvc-root/ 2>/dev/null || true
                echo "✓ Profile copied ($(du -sh /profile-pvc-root | cut -f1))"
              fi
              
              # Step 6: Copy to thumbs/cache tier
              echo ""
              echo "Step 6: Copying to cache tier..."
              mkdir -p /cache-pvc-root
              if [ -d "/source-upload/thumbs" ] && [ "$(ls -A /source-upload/thumbs 2>/dev/null)" ]; then
                cp -av /source-upload/thumbs/* /cache-pvc-root/ 2>/dev/null || true
                echo "✓ Cache/thumbs copied ($(du -sh /cache-pvc-root | cut -f1))"
              fi
              
              # Step 7: Ensure sync-queue structure
              echo ""
              echo "Step 7: Ensuring sync-queue structure..."
              mkdir -p /sync-queue-pvc-root
              if [ -d "/source-upload/sync-queue" ] && [ "$(ls -A /source-upload/sync-queue 2>/dev/null)" ]; then
                cp -av /source-upload/sync-queue/* /sync-queue-pvc-root/ 2>/dev/null || true
              fi
              
              # Step 8: Create .immich marker files at all PVC ROOTS (critical for subPath)
              echo ""
              echo "Step 8: Creating .immich marker files at PVC roots..."
              MARKER_CONTENT='{"version":1,"timestamp":"'$(date -u +%s)'"}'
              
              for pvc_root in /upload-pvc-root /library-pvc-root /profile-pvc-root /cache-pvc-root /sync-queue-pvc-root; do
                mkdir -p "$pvc_root"
                echo "$MARKER_CONTENT" > "$pvc_root/.immich"
                chmod 644 "$pvc_root/.immich"
                echo "✓ Created $pvc_root/.immich"
              done
              
              # Step 9: Create migration lock
              echo ""
              echo "Step 9: Creating migration lock..."
              echo "Migration completed at $(date -u)" > "$MIGRATION_MARKER"
              echo "✓ Lock file created"
              
              echo ""
              echo "========== Migration completed successfully =========="
              echo ""
              echo "Final state:"
              du -sh /upload-pvc-root/* 2>/dev/null | sort || echo "  (upload PVC)"
              echo "  library-pvc-root: $(du -sh /library-pvc-root 2>/dev/null | cut -f1)"
              echo "  profile-pvc-root: $(du -sh /profile-pvc-root 2>/dev/null | cut -f1)"
              echo "  cache-pvc-root: $(du -sh /cache-pvc-root 2>/dev/null | cut -f1)"
              echo ""
              echo "Marker files verification (PVC roots only):"
              find /upload-pvc-root /library-pvc-root /profile-pvc-root /cache-pvc-root /sync-queue-pvc-root -maxdepth 1 -name ".immich" -type f 2>/dev/null | sort
          
          volumeMounts:
            # Source: existing immich-upload (all current data)
            - name: immich-upload
              mountPath: /source-upload
            
            # Destinations: PVC roots (for marker file creation)
            - name: immich-upload
              mountPath: /upload-pvc-root
            - name: immich-library
              mountPath: /library-pvc-root
            - name: immich-cache
              mountPath: /cache-pvc-root
            - name: immich-profile
              mountPath: /profile-pvc-root
            - name: immich-sync-queue
              mountPath: /sync-queue-pvc-root


      containers:
        - name: immich-server
          image: ghcr.io/immich-app/immich-server:v2.4.1  # Check for latest version
          imagePullPolicy: IfNotPresent
          env:
            # CONFIGURE INTEL DRIVER
            - name: LIBVA_DRIVER_NAME
              value: "iHD"  # Crucial for N97/Alder Lake
            # REMOVED: IMMICH_HOST (Now provided via configMap as 0.0.0.0)
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: immich-db-secret  # The secret name you confirmed
                  key: password
            # API Key for Job Scheduler - To be populated by user via Secret
            - name: IMMICH_API_KEY
              valueFrom:
                secretKeyRef:
                  name: immich-secret
                  key: api_key
                  optional: true
          envFrom:
            - configMapRef:
                name: immich-config
            - secretRef:
                name: immich-secret
          ports:
            - containerPort: 2283
              name: http
          livenessProbe:
            httpGet:
              path: /api/server/ping
              port: 2283
            initialDelaySeconds: 60
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/server/ping
              port: 2283
            initialDelaySeconds: 10
            periodSeconds: 10
          volumeMounts:
            # MOUNT GPU DEVICE
            - name: dev-dri
              mountPath: /dev/dri
            - name: immich-upload
              mountPath: /usr/src/app/upload/upload
              subPath: "upload"
            - name: immich-upload
              mountPath: /usr/src/app/upload/backups
              subPath: "backups"  # Root of upload volume for initial structure
            - name: immich-upload
              mountPath: /usr/src/app/upload/encoded-video
              subPath: "encoded-video"
            #Tiered storage
            - name: immich-cache
              mountPath: /usr/src/app/upload/thumbs
            - name: immich-library
              mountPath: /usr/src/app/upload/library
            - name: immich-profile
              mountPath: /usr/src/app/upload/profile
            - name: immich-sync-queue
              mountPath: /usr/src/app/upload/sync-queue

        # Sidecar: Job Scheduler
        # Native Immich doesn't schedule storage migration automatically
        # This sidecar triggers it via API
        - name: job-scheduler
          image: alpine:3.19
          securityContext:
            runAsUser: 0  # Required to install packages via apk
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache curl netcat-openbsd && \
              /scripts/job-scheduler.sh
          env:
             - name: IMMICH_API_KEY
               valueFrom:
                 secretKeyRef:
                   name: immich-secret
                   key: api_key
                   optional: true
          volumeMounts:
            - name: scripts-volume
              mountPath: /scripts


      volumes:
        - name: dev-dri
          hostPath:
            path: /dev/dri
        - name: immich-upload
          persistentVolumeClaim:
            claimName: immich-upload
        - name: immich-library
          persistentVolumeClaim:
            claimName: immich-library
        - name: immich-cache
          persistentVolumeClaim:
            claimName: immich-cache
        - name: immich-profile
          persistentVolumeClaim:
            claimName: immich-profile
        - name: immich-sync-queue
          persistentVolumeClaim:
            claimName: immich-sync-queue
        - name: scripts-volume
          configMap:
            name: immich-config
            defaultMode: 0755
